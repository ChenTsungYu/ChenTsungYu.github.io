# [AWS] SysOps 證照筆記整理
###### tags: `AWS`

# Monitoring & Reporting
## Cloudwatch
![](https://i.imgur.com/cHicVsN.png)
用於監控其他 AWS 服務情況，如: 
- Compute:
    - Autoscalling group
    - ELB
    - Route53 Healthy Check
- Storage & Content Devivery:
    - EBS
    - Storage Gateway
    - Cloudfront
- Others:
    - Cloudwatch log
    - SQS
    - SNS
    - **Estimated Charges on AWS Bill**

### Cloudwatch 應用場域
不只限於 AWS Service，也**可用於地端 (On-premise)**![](https://i.imgur.com/4F4FWpI.jpg)
可透過安裝 SSM Agent or  Cloudwatch Agent 於目標機器中，蒐集相關得 metrics 後回傳至 Cloudwatch Dashboard
### Cloudwatch 儲存 Log 的時間多長？
![](https://i.imgur.com/5Ne2ncS.jpg)
Cloudwatch 預設會**無限制存放** log 資料，甚至仍**可提取被 Terminated 的 EC2 or ELB 的資料**

## EC2
監控 EC2 (Host Level) 的指標標含：
- **Default metrics:**
    - CPU: cpu utilization + credit usage
    - Network: network in + out
    - Disk: read/write for Ops/Bytes
    - Status Check:
        - instance status = check the ec2
        - system status = check the underlying hardware

**Default Time interval: 5 min**
**Ram** is not included in the aws ec2 metrics
- **Custom metrics:**
ec2 的 Metrics 相關範例:
    - ram usage
    - swap usage

### Metrics granularity (粒度) -> for ec2
- basic(normal) monitoring(default):
  metrics are collected at a **5 min** interal 
- detailed monitor(paid): 
  metrics are collectd at a **1 min** interval includes CPU, Network, Disk and Status Check Metrics; or your can set 3 mins or any amount less than 5 mins
- custom metric
basic resolution: minimum granularity is **1 min** 
high resolution: all the way to 1 second resolution
![](https://i.imgur.com/QWG1e7m.png)

### Cloud Alarm
設置門檻值，可用於整合 EC2 CPU Utilizaion, ELB or Charges on AWS Billing 發布警報

## EBS
- an ebs volume is a network drive you can attach to your instances while the run 
- it allows your instances to **persist data**
- it's a **network drive** (not a physical drive)

#### EBS Type 
![](https://i.imgur.com/uBpbbeW.jpg)
![](https://i.imgur.com/IQdWp3L.jpg)
- General Purpose (SSD) - gp2: 
    - 低延遲
    - system boot volumes
    - 適合**開發、測試環境**
    - 最高上限為 10,000 IOPS; 16GB
- Provision IOPS (SSD) - io1
    - for critical business app
    - 可容許**大於 10,000 IOPS** or 160 MB/s of hhroughput of per volumn
    - 適用於 IOPS 較高的情況: 單位時間內系統能處理的I/O請求數量
    - 亦適用於高吞吐量(Throughput)的需求: 單位時間內傳輸的資料量
    - 適合**大規模工作量的資料庫(DB)**
    - 延伸閱讀：[儲存設計-IOPS](https://blog.xuite.net/attlee.ken/twblog/240772147-%E5%84%B2%E5%AD%98%E8%A8%AD%E8%A8%88-IOPS)
- Throughput Optimized (HDD) - st1
    - 適用於資料串流(straming)的場景: 資料是持續的
    - 適合**Big Data, Data warehouse, Log processing**
    - **Cannt be a boot volume**
    - 延伸閱讀： [Big Data Battle : Batch Processing vs Stream Processing](https://gowthamy.medium.com/big-data-battle-batch-processing-vs-stream-processing-5d94600d8103)
- Cold (HDD) -sc1
    - 以高吞吐量為主的儲存方案
    - **lowest storage cost**
    - **infrequently accessed**
    - **Cannt be a boot volume**

補充：
- HDD 類型的 EBS 無法提供皆 boot volume(You cannt boot OS from them)
- EBS is **no pre-warming (no require initializaion) needed**; [reference](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-initialize.html)
- **storage blocks on volumes restored from snapshot (e.g. pull from S3 and written to volumns) must be initialize**

#### EBS Volumn Status check
- ok: normal
- **warning**: degrade, severely degrade
- **impaired**: stalled, Not available
- insufficient data: insufficient data

**Exam Tip:**
Know that Degraded or Severely Degraded = Warning
Stalled or Not Available = Impaired

#### Modified EBS Volumn
![](https://i.imgur.com/vRgHsBA.png)
![](https://i.imgur.com/XlUE6qP.png)

## ELB: Elastic Load Balancer 
Elastic Load Balancer Type
- Application
    - layer7
    - multiple http application across machines 
    - multiple applications on the same machine 
    - base on route in url
    - base on hostname in url
    - awesome for micro service and container-base application 
    - has port mapping feature to redirect to a dynamic port 
    - stickiness can be enabled at the target group level
        - same request goes to the same instance
        - stickiness is directly generated by the alb(not the applicaion)
- Network 
    - for ultra-high performace scenario
    - static ip address
    - be capable of handling millions of requests/sec
    - 
- Classic

### Monitoring type
- Cloudwatch metrics
     - data points to Amazon CloudWatch for load balancers
- Access log: 
    - capture detailed information about requests sent to your load balancer. You can use these access logs to analyze traffic patterns and troubleshoot issues
    - **disabled by default**
    - time interval: 5 mins, 60mins
    - Could be stored in S3
    - only pay for s3 storage
    - ogs are already encrypted
    - information include:
        - time
        - Client ip
        - latencies
        - request paths
        - server response
        - trace id
    - Important:
      ![](https://i.imgur.com/sDDroZ5.png)
- Request tracing:
  - To track HTTP requests from clients to target services
  - **only available for ALB**
  - add or update the X-Amzn-Trace-Id header
![](https://i.imgur.com/I9N4yBh.png)
- CloudTrail log:
  - capture the detail information about ELB API Call 
  - log file cloud be stored in S3
## Cloudwatch v.s. Cloudtrail
- Cloudwatch monitoring performance
    - number of request
    - CPU Utilization
    - Memory Utilization
- Cloudtrail monitoring API Call in AWS platform
    - Auditing things
    - Monitoring activities of users
## Elasticcache
### Consist of two engines
- Memcached
    - an in-memory **object store**
    - cache doesn't survive reboots
    - Can handle the loads up to 90% 
- Redis
    - in-memory **key-value store**
    - super low latency
    - **four core**: e.g. 90% CPU Utilization，the threshold for CPU Utilization would be 22.5
### Monitoring CPU Utilization type
- CPU Utilization
- Swap Usage
- Evictions
- Concurrent Connections 

### SwapUsage
![](https://i.imgur.com/3eJBqeH.png)
The Swap File (or Paging File) is **the amount of disk storage space reserved on disk** if your computer runs out of ram.
- (Typically) the size of swap file = the size of RAM
#### Memcached
- shloud be about 0 and not exceed 50Mb
- if Memcached exceed 50Mb, U should increase memcached_connections_overhead parameter
#### Redis
- **use reserved-memory, not SwapUsage**
### Evictions
![](https://i.imgur.com/SCoLS5c.png)![](https://i.imgur.com/HCtX0Sb.png)
#### Memcached
- There is **no recommended setting** ; Choose a threshold based off your application
- **Scale Up** (ie increase the memory of existing nodes) OR **Scale Out** (add more nodes)，兩者任一
#### Redis
- There is **no recommended setting** ; Choose a threshold based off your application
- only increase the memory of existing nodes) OR **Scale Out** (add more nodes)
### Concurrent Connections
- There is **no recommended setting**. Choose a threshold based off your application
- **Remember to set an alarm on the number of concurrent connections for elasticache**

## Organizations
- global service
- allows to centrally manage policies across multiple aws accounts
- the main account is the master account -- you can't change it other accounts are member accounts
- Control Access To AWS Services
- member accounts can **only be part of one organization**
- **consolidated billing across all accounts -- single payment method**
- pricing benefits from **aggregated usage**(volume discount for ec2, s3...)
- api is available to automate aws account creation and management

### Control Access To AWS Services
- could create Service Control Policies (SCPs) centrally control AWS service use across multiple AWS accounts
- could specifically **Allow or Deny individual AWS Services**
### OU & service control policies(SCPs)
![](https://i.imgur.com/LAXh8mk.png)
- organize accounts in organizational unit(OU)
    - can be anything: dev/test/prod or finance/hr/it 
    - can nest OU within OU
    - helpful to separate dev and pro resources 
    - helpful to only allow approved services
    - apply service control policies(scps)to ou
        - permit/deny access to aws services
        - scp has a similar syntax to iam
        - it's a filter to iam

## Resource Group
make it easy to group your resources using the tags that are assigned to them. You can group resources that share one or more
tags. -> 藉由標籤 (Tag) 替 Resource 做分組歸類，便於進行管理。標籤可以對共享一個或多個資源進行分組
![](https://i.imgur.com/a9u80cb.jpg)

### Resource groups 包含
1. Region
2. Name
3. Health Checks
#### Specific information
- For EC2 - Public & Private IP Addresses
- For ELB - Port Configurations
- For RDS - Database Engine etc

### Note
- Case Sensitive
- 可搭配 System Management 做自動化

## Cost Explore
A tool is enable to view and analyze the cost
- can view data for up to the **last 13 months**
- forecast how much will likely spent for the next three months
- get recommendations for what Reserved Instances (RI) to purchase
- Use tags to tag your resources.
- Configure tags for cost centres (such as by department, employee id etc).
- Activate cost allocation tags to track your costs by tags.

## EC2 Pricing Modal
### Reserved
- Applications with steady state or predictable usage (穩定且可預測的使用量) 
- Users able to make upfront payments to reduce their total computing costs even further (預先進行付款可享有更優惠的價格)
    - Standard RI’s： Up to **75% off** on demand
        - reservation period can 1 ~ 3 years
        - reserve a specific isntance type
        - pay upfront for waht you use with long-term ( > 1 year) commitment
    - Convertible RI’s： Up to **54% off** on demand) capability to change the attributes of the RI as long as the exchange results in the creation of Reserved Instances of equal or greater value
    - Scheduled RI’s： available to launch within the time windows you reserve. This option allows you to match your capacity reservation to a predictable recurring schedule that only requires a fraction of a day, a week, or a month(可在預定的時間範圍內啟動。可將容量保留與可預測的定期計劃，如該計劃僅需要一天，一周或一個月的一小部分)

### Spot
short workloads, for cheap, can lose instances. 
- Apps have flexible start&end times
- Apps are only feasible at very low compute prices (僅在非常低的計算價格下可行)
- Users with urgent computing needs for large amounts of additional capacity (需要大量的額外容量應付緊急需求的用戶)
- can get discount of up to **90%** compare to on demand
- **used for batch jobs, big data analysis, or workloads that are resilient to failures**
- not suitable for critical jobs or databases

### Dedicated Hosts (專用主機)
no other customers will share you hardware
- Useful for regulatory requirements that may not support multitenant virtualization.
- Great for licensing which does not support multi-tenancy or cloud deployments.
- Can be purchased On-Demand (hourly.)
- Can be purchased as a Reservation for up to 70% off the OnDemand price.

### 小結
- On Demand - allow you to **pay a fixed rate by the hour** (or by the second) with no commitment.
- Reserved - provide you with a capacity reservation, and offer a significant discount on the hourly charge for an instance.1 Year or 3 Year Terms
- Spot - enable you to bid whatever price you want for instance capacity, providing for even greater savings if your applications have flexible start and end times. (It might be shut down suddently)
- Dedicated Hosts - Physical EC2 server dedicated for your use. Dedicated Hosts can help you reduce costs by allowing you to use your existing server-bound software licenses

## AWS Config
[FAQs](https://aws.amazon.com/config/faq/?nc1=h_ls)
- enable **compliance auditing**, **security analysis**, **resource change tracking**
- discover existing AWS resources
- export a complete inventory of your AWS resources with all configuration details
- determine how a resource was configured at any point in time
- Configuration snapshots and logs config changes of AWS resources
- Automated compliance checking
- 可以透過 Amazon Simple Notification Service (SNS) 取得每個組態變更的通知
- can be aggregated across regions and accounts

### 相關術語
- Configuration History
Collection of config items for a resource
over time.
- Configuration Recorder
The configuration of Config that records
and stores config items.

### Recorder setup
- Logs config for account in region
- **Stores in S3**
- Notifies with SNS

### What can be seen in AWS Config:
- Resource Type
- Resource ID
- Compliance
- Timeline
- Configuration Details
- Relationships
- Changes
- CloudTrail Events

### Config Rules
1. Compliance Check：Periodic, Configuraion Snapshot Delivery
2. Managed Rule
3. Permissions needed for Config
![](https://i.imgur.com/IUHwx0L.jpg)
4. Restrict Access:
![](https://i.imgur.com/9YrLxIg.jpg)
5. Monitoring Config:
![](https://i.imgur.com/eAmNK4J.jpg)

## cloudtaych vs cloudtrail vs config
### cloudwatch
performance monitoring(metrics, cpu, network, etc...) & dashboards events & alerting
log aggregation & analysis
### cloudtrail
- record api calls made within your account by everyone 
- can define trails for specific resources
- global service
### config
- record configuration changes
- evaluate resources against compliance rules 
- get timeline of changes and compliance

## AWS Service Health Dashboard vs Personal Health Dashboard
### Service Health Dashboard
it basically shows the health of each AWS Service
![](https://i.imgur.com/cOixaR9.png)

### Personal Health Dashboard
it provides alerts and remediation guidance when AWS is experiencing events that may impact you.
![](https://i.imgur.com/I8mTrA3.png)

# Deployment & Provisioning
## Common reasons why EC2 instances may fail to launch
- **InstanceLimitExceeded error:**
reach the number of intstance u can launch in a region (default limit of the number of instance in a region is **20**)
- **InsufficientInstanceCapacity error:**
AWS does not currently have enough available On-Demand capacity to service your request
**sol:**
    - Wait a few minutes and try again
	- Request fewer instances
	- Select a different instance type
	- Try purchasing Reserved Instances instead
	- Submit a new request without specifying the Availability Zone
    
## EBS Volumes
- allows you to create storage volumes and attach them to your EC2 instances

### 2 different variants of SSD:
- gp2 - General Purpose - boot volumes
- io1- Provisioned IOPS - I/O intensive, NoSQL / relational databases, latency sensitive workloads

**IOPS (Input/Output Operations per second):** 
used to benchmark performance for SSD volumes

### Scenario: Hitting the IOPS Limit of your Volume
**Q:** 
What happens if your are using gp2 and your workload exceeds the IOPS limit of the gp2 volume you have provisioned?
**A:**
- You will start to get your I/O requests queuing
- Depending on your application’s sensitivity to IOPS and latency, you may see your application becoming slow

**Sol:**
two approaches to address hitting the IOPS limit:
1. For gp2, you can increase the size of your volume — but if your volume is already **5.2TB** or more, you will have already reached the **16,000 IOPS limit for gp2 volumes**
2. If you need more than 16,000 IOPS, you will need to **change your storage class to Provisioned IOPS**

## Bastion Hosts
def: a host located in your **Public subnet.**

- Allows you to connect to your EC2 instances using **SSH or RDP only**.
- You can log-in to the Bastion host over the internet, from your desktop.
- You then use the Bastion host to initiate an SSH / RDP session over the Private subnet to your EC2 instances in the Private subnet.
- This allows you to **safely administer your EC2 instances without exposing them to the internet** (Used to **securely connect to instances in a Private subnet**)

### Architecture
![](https://i.imgur.com/otzzvOX.png)
- Sys Admin team connect to the Bastion over the internet.
- The Bastion connects to your instances over the Private subnet.

## AWS Load Balancer
There are three type of Load Balancer
### Application Load Balancer
- Operating at OSI layer 7 (on Application layer) -> HTTP(s) 協定
- url based routing
- **does not support static ip**, but **has a fixed dns**
- ![](https://i.imgur.com/JtfhPJS.png)

### Network Load Balancer
- Operating at OSI layer 4 (on Transport layer) -> TCP/IP; UDP
- **super fast performance** (Use for extreme performance!)
- **most expensive**
- provide **static(or elastic) ip address**
- suitable for the application where latency is really important
- ![](https://i.imgur.com/6k3Rxft.png)

### Classic Load Balancer
legacy option (not recommend option)
### pre-warming
- elb scale gradually to traffic
- elb may fail in case of sudden(突然), spike(穿刺) of traffic (a sudden increase of traffic of this scale)
- ![](https://i.imgur.com/K3b6xxk.png)
- if you expect high traffic, open a support ticket with aws to pre-warm your elb:
    - duration (start and end dates) of traffic 
    - expected requests per second (expected requests rate)
    - Total size of request

### extra information
You don’t have to choose one or the other, you can get the benefit of both, by putting an ALB behind a NLB.
![](https://i.imgur.com/vHvNJUn.jpg)

### Load Balancer Error Messages
**Code:**
- **200**: success
- **4xx**: error from client side
    - **400**: Bad request e.g. header is malformed
    - **401**: Unauthorized -> user access denied
    - **403**: Forbidden -> request is blocked by WAF access control list
    - **460**: client closed connection -> client timeout period may be too short
    - **463**: x-forwarded-for header > **30 ip**
- **5xx**: error from server side 
    - **500**: internal server error -> e.g. error on the load balancer
    - **502**: Bad gateway -> e.g. application server closed the connection or sent back a malformed response
    - **503**: Service Unavailable -> no registered targets
    - **504**: Gateway timeout -> e.g. application is not responding - problem with your web server, application server or database.
    - **561**: Unauthorized -> received an error code from the ID provider when trying to authenticate a user

### common troubleshooting
- check security group
- check health checks
- sticky sessions may bring imbalance on the LB side
- for multi az, make sure cross zone balancer is enabled
- user internal lb for private applications that don't need a public access 
- enable deletion protection to prevent against accidental deletes

### Monitoring
all lb metrics are directly pushed to **cloudwatch metrics**
metrics are gather at **60 seconds intervals (default)**
#### General health
- **Backend Connection Error:** number of unsuccessful connections to backend instances
- **health host count / unhealthy host count:** number of healthy / unhealthy instances registered
- **HTTPCode_Backend_2XX,3XX,4XX,5XX**: number of HTTP response codes generated by the registered instances.

#### Performance Metric
- **Latency**: number of seconds taken for registered instance to **respond / connect**
- **RequestCount**: number of requests completed / connections made during the specified interval (1 or 5 mins)
- SurgeQueueLength - number of pending requests, max queue size is 1024, additional requests will be rejected **(Classic only)**
- SpilloverCount - number of requests rejected because the surge queue is full **(Classic only)**

### Summary
![](https://i.imgur.com/XF8mZPu.jpg)

## System Management 
a management tool which gives you **visibility and control over AWS infrastructure**
- Integrates with CloudWatch: provide dashboards to view e.g. operational data & detect problems
- Organize your inventory, grouping resources (resource groups) together by application or environment including **on-premises systems**
- Includes **Run Command** which **automates operational tasks across resources** — e.g. security patching, package installs.

### Run Command
- Allow to run **pre-defined commands** on one or more EC2 instances
- Stop, restart, terminate, re-size instance
- Attach / detach EBS volumes
- Create snapshots, backup DynamoDB tables
- Apply patches and updates
- Run an Ansible playbook
- Run a shell script
- integrated with aws config
- state manager: define and maintaining configuration of os and applications

### how ssm works
- install the ssm agent onto the system we control
- installed by default on amazon linux ami and some ubuntu
- if an isntance can't be controlled with ssm it's probably an issue with the ssm agent 
- make sure the ec2 isntance have a proper iam role to allow ssm actions

### ssm resource groups
- create, view or manage logical group of resources thanks to tags
- allows creation of logical groups of resources such as:
    - applications
    - different layers of an application stack 
    - production versus development stack
- regional service
- works with ec2, s3, synamoDB, lambda, etc...

### SSM Documents
- documents can be in **json or yaml **
- user define parameters
- user define actions
- main documents already exist in aws

## Placement Group
![](https://i.imgur.com/kwyPRi7.png)
**Advantage:**
Allow users to control how thier EC2 instances are deployed 
**scenario:**
sometimes you want control over the ec2 instance placement strategy
### Three types of Placement Group
![](https://i.imgur.com/V6RAhcm.png)
- Cluster: instances are all created in a single AZ -> **Low latency, high network throughput** ![](https://i.imgur.com/36gLmN5.png)
- Partition: instances are created **in a logical segment** call partition (can be **Multi-AZ**)
![](https://i.imgur.com/FK2Tx2B.png)
- Spread: spreads instances across underlying hardware(max 7 instances per group per AZ) -> **Max availability in order to minimize the impact**
![](https://i.imgur.com/hTzmgna.png)

# High Availability
## Elasticity v.s. Scalability
### Elasticity (horizontal)
Elasticity allows you to stretch out and retract back your infrastructure
- **based on your demand**
- **only pay for what you need**
- is used during a **short time period**. e.g. hours or days
### Scalability (vertical)
building out the infrastructure to **meet your demands long term** (e.g. weeks, days, months and years)
### Sample
![](https://i.imgur.com/IBKBFUk.png)
![](https://i.imgur.com/qYssZ3D.png)
### Tips
![](https://i.imgur.com/z62Kt5t.png)

# RDS
- A relation database service
- it's a managed db service for db use sql as a query language allow you create db in the cloud that are managed by aws e.g. postgresql, oracle mysql, mariadb, mssql, aurora

## RDS Multi-AZ Failover
**Multi-AZ: **
keeps a copy of your production database in a separate Availability Zone -> can recover from failure or disaster.
- sync replication (synchronous physical / logical replication to **keep data on the standby up-to-date with the primary**)
- one DNS name - automatic app failover to stanby
- increase availability
- failover in case of loss of az, loss of network, instance or storage failure
- database operations can resume quickly without administrative intervention (automatically)

![](https://i.imgur.com/Q4mIiuJ.jpg)

> Multi-AZ is **for Disaster Recovery only**
> Multi-AZ is **not a scalling solution**

### synchronous logical replication v.s. synchronous physical replication 
- synchronous logical replication -> **MS SQL Server**
- synchronous physical replication -> **MySQL, Oracle, and PostgreSQL**

### Multi-AZ Failover Advantages
- High availability
- Backups Restore’s are taken from secondary which avoids I/O suspension to the primary

![](https://i.imgur.com/AYNagA1.png)

### Tips
> **Read Replica’s are used to scale**
> 
> Amazon handles the failover for you. Done by
updating the **private DNS** for the database
endpoint. => Don't worry about change ip address

## RDS read replicas
- allowed to **elastically scale out** beyond the capacity constraints of a single DB Instance for **read-heavy database workloads**.
- **Read only copies** of your database
- For **performance improvement**, you need **Read Replicas**

