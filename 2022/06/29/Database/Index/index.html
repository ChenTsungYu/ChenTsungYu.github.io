<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>[Postgres] 資料庫的索引(Index) - Tom&#039;s Blog</title><link rel="manifest" href="../../../../../manifest.json"><meta name="application-name" content="Tom&#039;s Blog"><meta name="msapplication-TileImage" content="/img/dragon_red.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Tom&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="前言上一篇記錄了資料庫儲存資料的概念與其儲存結構，本文將初步探討資料庫裡的索引(Index)，了解 Index 的作用、行為以及實際操作方式。"><meta property="og:type" content="blog"><meta property="og:title" content="[Postgres] 資料庫的索引(Index)"><meta property="og:url" content="https://github.com/ChenTsungYu/2022/06/29/Database/Index/"><meta property="og:site_name" content="Tom&#039;s Blog"><meta property="og:description" content="前言上一篇記錄了資料庫儲存資料的概念與其儲存結構，本文將初步探討資料庫裡的索引(Index)，了解 Index 的作用、行為以及實際操作方式。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://github.com/images/pg.png"><meta property="og:image" content="https://github.com/images/index-query.png"><meta property="og:image" content="https://github.com/images/b-tree-nodes.png"><meta property="og:image" content="https://github.com/images/org-heap.png"><meta property="og:image" content="https://github.com/images/btree-node-heap.png"><meta property="og:image" content="https://github.com/images/btree-disk-mem.png"><meta property="article:published_time" content="2022-06-29T05:23:10.000Z"><meta property="article:modified_time" content="2022-08-12T14:41:16.425Z"><meta property="article:author" content="Tsung Yu Chen"><meta property="article:tag" content="Database"><meta property="article:tag" content="Postgres"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/pg.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/ChenTsungYu/2022/06/29/Database/Index/"},"headline":"[Postgres] 資料庫的索引(Index)","image":["https://github.com/images/pg.png","https://github.com/images/index-query.png","https://github.com/images/b-tree-nodes.png","https://github.com/images/org-heap.png","https://github.com/images/btree-node-heap.png","https://github.com/images/btree-disk-mem.png"],"datePublished":"2022-06-29T05:23:10.000Z","dateModified":"2022-08-12T14:41:16.425Z","author":{"@type":"Person","name":"Tsung Yu Chen"},"publisher":{"@type":"Organization","name":"Tom's Blog","logo":{"@type":"ImageObject","url":"https://github.com/img/dragon_blue.png"}},"description":"前言上一篇記錄了資料庫儲存資料的概念與其儲存結構，本文將初步探討資料庫裡的索引(Index)，了解 Index 的作用、行為以及實際操作方式。"}</script><link rel="canonical" href="https://github.com/ChenTsungYu/2022/06/29/Database/Index/"><link rel="icon" href="../../../../../img/dragon_red.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="../../../../../css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="../../../../../index.html"><img src="../../../../../img/dragon_blue.png" alt="Tom&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="../../../../../index.html">Home</a><a class="navbar-item" href="../../../../../archives">Archives</a><a class="navbar-item" href="../../../../../categories">Categories</a><a class="navbar-item" href="../../../../../tags">Tags</a><a class="navbar-item" href="../../../../../about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="../../../../../https:/github.com/ChenTsungYu"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-29T05:23:10.000Z" title="6/29/2022, 1:23:10 PM">2022/06/29</time></span><span class="level-item"><a class="link-muted" href="../../../../../categories/Backend/">Backend</a></span><span class="level-item">29 minutes read (About 4328 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">[Postgres] 資料庫的索引(Index)</h1><div class="content"><!-- toc -->

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><img src="/images/pg.png" alt=""><br><a target="_blank" rel="noopener" href="https://chentsungyu.github.io/2022/06/20/Database/%E8%B3%87%E6%96%99%E5%BA%AB%E5%A6%82%E4%BD%95%E5%AD%98%E6%94%BE%E8%B3%87%E6%96%99/#Index-%E6%98%AF%E5%A6%82%E4%BD%95%E5%AD%98%E6%94%BE%E5%9C%A8-Disk-%E7%B0%A1%E5%8C%96%E7%9A%84%E7%89%88%E6%9C%AC">上一篇</a>記錄了資料庫儲存資料的概念與其儲存結構，本文將初步探討資料庫裡的<strong>索引(Index)</strong>，了解 Index 的作用、行為以及實際操作方式。</p>
<span id="more"></span>

<blockquote>
<p>本篇主要筆記 <a target="_blank" rel="noopener" href="https://www.udemy.com/course/sql-and-postgresql/">Udemy - SQL and PostgreSQL: The Complete Developer’s Guide</a> 及 <a target="_blank" rel="noopener" href="https://www.udemy.com/course/database-engines-crash-course">Udemy - Fundamentals of Database Engineering</a> 的課程內容，但以自己較易理解的方式加以整理，可能和原課程內容有些出入。</p>
</blockquote>
<p>資料庫未使用 Index 的情況下，會採<strong>讀取整張表</strong>的方式來找出目標資料，這種搜尋方式作 Full Table Scan。</p>
<h1 id="Full-Table-Scan"><a href="#Full-Table-Scan" class="headerlink" title="Full Table Scan"></a>Full Table Scan</h1><p>Full Table Scan 中文翻作全表掃描，又作 <code>Sequential Scan</code>，按順序讀取整張資料表，搜尋效率最差，過程中涉及多次 I/O 讀取 Heap Table File 裡的 page。</p>
<p>試想一下，若要在厚厚的一本書(資料表)裡找出某個文字段落(某筆資料)，在沒有目錄的幫助下，肯定是一頁一頁找，得花上不少時間，資料庫也是同等道理。</p>
<p>因此我們需要找方法來提升查詢效率，其中一個方式就是 <strong>Index</strong>。</p>
<h1 id="什麼是-Index"><a href="#什麼是-Index" class="headerlink" title="什麼是 Index?"></a>什麼是 Index?</h1><blockquote>
<p>Index 就類似於一本書(資料表)的<strong>目錄</strong>，我們能根據目錄快速地找到想要的內容所在位置。</p>
</blockquote>
<p>Index 一般來說都採用 <code>B-Tree</code> 的資料結構，也是最常見的 Index 類型，除了 B-Tree 外還有<a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/indexes-types.html">其他類型</a>，本篇主要聚焦在 B-Tree，index 裡除了被設置為 index 欄位的值外，會有個 row pointer (指針) 指向該 row 位於 Heap Table File 的位置，讓資料庫能有效地根據 pointer 參照的位置取得資料，藉此改善查詢效率。</p>
<p>透過 Index 查詢的流程如下圖所示：<br><img src="/images/index-query.png" alt=""></p>
<p>執行 SQL <code>SELECT</code> 時查找使用者名為 <code>Tom</code> 的資訊，若 Index 裡找出 Tom 這個人，取得 Tom 在 Heap Table File 的位置為 Block 1，資料庫會直接到 Heap File 的 Block 1 裡取出 Tom 的資料，而非從第一個 block 開始搜尋，過程中會經歷兩次 I/O (兩次 I/O 的過程可以參考<a target="_blank" rel="noopener" href="https://chentsungyu.github.io/2022/06/20/Database/%E8%B3%87%E6%96%99%E5%BA%AB%E5%A6%82%E4%BD%95%E5%AD%98%E6%94%BE%E8%B3%87%E6%96%99/#Index-%E6%98%AF%E5%A6%82%E4%BD%95%E5%AD%98%E6%94%BE%E5%9C%A8-Disk-%E7%B0%A1%E5%8C%96%E7%9A%84%E7%89%88%E6%9C%AC">前一篇討論</a>)。</p>
<h2 id="什麼是-B-Tree"><a href="#什麼是-B-Tree" class="headerlink" title="什麼是 B-Tree?"></a>什麼是 B-Tree?</h2><p>B-Tree 是一種常用於外部存儲的資料結構，適用於讀&amp;寫資料區塊相對大的儲存系統，結構為 <code>m-way</code> 的自平衡搜尋樹，B 即 Balance 的意思，存放 <strong>有序</strong> 的資料，樹的節點 (node) 裡有儲存鍵值對(key-value pair)的元素(element)，分別存 index 的位置與該筆資料於 Heap File 的位置，父層節點會透過 pointer 指向子節點 。</p>
<p>常見應用：資料庫、文件系統<br><img src="/images/b-tree-nodes.png" alt="B-Tree"></p>
<blockquote>
<p>幾個重要名詞:<br>Degree: 分支度，一個 node 擁有子樹的個數<br>Root Node: 樹的最上層<br>Internal Node: 至少有一個子節點<br>Leaf Node: 沒有子樹</p>
</blockquote>
<h3 id="B-Tree-幾項重要特性"><a href="#B-Tree-幾項重要特性" class="headerlink" title="B-Tree 幾項重要特性"></a>B-Tree 幾項重要特性</h3><ul>
<li>根節點 (Root Node) 至少有兩個子節點(Child Node)</li>
<li>可以為空</li>
<li>所有的 Leaf Node 都在同一階層</li>
<li>除了 Root Node、Leaf Node 外，其他節點至少會有個子節點，最多有 m 個</li>
<li>同個節點裡的 key 是升冪排列</li>
<li>B-Tree的高度: 不包含 Leaf Node 的階層數</li>
<li>B-Tree的高度和磁碟存取時的 I/O 次數有正相關，影響走訪(traversal)整棵樹的時間複雜度</li>
</ul>
<h3 id="B-tree-是如何幫助資料庫搜尋"><a href="#B-tree-是如何幫助資料庫搜尋" class="headerlink" title="B-tree 是如何幫助資料庫搜尋?"></a>B-tree 是如何幫助資料庫搜尋?</h3><p>設置 index 時，會指定哪個欄位作為 index 的資料，資料庫會將 Heap Table File 裡該欄位的值及對應的位置。</p>
<p>下圖以 user name 作為 index 的範例：<br><img src="/images/org-heap.png" alt=""></p>
<p>index 的內容包含了 user name (e.g. Alf)、該筆資料於 heap file 的位置(e.g. block 0)，並以字母為依據進行排序，排序好 index 值後會被放入樹狀的資料結構裡，樹的葉節點存放一個個鍵值(key-value)的元素，而 root node 會定義好一些規則判別要到哪個葉節點取資料。</p>
<p><img src="/images/btree-node-heap.png" alt=""><br>上圖範例是找出 Riann 這個 user name，資料庫進行 index 搜尋時找出右方葉節點裡的 Riann，並藉由 pointer 得知 Riann 位於 Heap File 的 block 1，就直接從 block 1 裡找資料，而不會從 block 0 開始找，加快搜尋的時間。</p>
<h3 id="Index-存放於-Disk-amp-Memory-的示意圖"><a href="#Index-存放於-Disk-amp-Memory-的示意圖" class="headerlink" title="Index 存放於 Disk &amp; Memory 的示意圖"></a>Index 存放於 Disk &amp; Memory 的示意圖</h3><p><img src="/images/btree-disk-mem.png" alt=""><br>Disk 裡 Index 會包含 Heap File 的 meta data、根節點、葉節點的資料等</p>
<h1 id="Clustered-Index-v-s-Non-clustered-Index"><a href="#Clustered-Index-v-s-Non-clustered-Index" class="headerlink" title="Clustered Index v.s. Non-clustered Index"></a>Clustered Index v.s. Non-clustered Index</h1><p>Clustered Index 是根據資料在儲存空間上的排序而建立，而 Non-clustered Index 不一定要按照實體資料的排序而建立。</p>
<h2 id="Clustered-Index"><a href="#Clustered-Index" class="headerlink" title="Clustered Index"></a>Clustered Index</h2><p>中文作 <strong>叢集索引</strong> ，概念類似書(比喻作資料表)的<strong>目錄</strong>，用於快速查找書的內容，而每本書會有一個目錄，所以每張資料表只會有<strong>一個 Clustered index。</strong></p>
<p>事實上，Clustered Index 的機制在不同的關連式資料庫有不同的實作方式，如: SQL Server裡預設會將 <strong>Primary Key (主鍵)</strong> 作為 Clustered Index。</p>
<p>以下引用自 MS SQL server <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-table-transact-sql?redirectedfrom=MSDN&view=sql-server-ver16">文件</a>：</p>
<blockquote>
<p>CLUSTERED | NONCLUSTERED<br>Indicate that a clustered or a nonclustered index is created for the PRIMARY KEY or UNIQUE constraint. <code>PRIMARY KEY constraints default to CLUSTERED, and UNIQUE constraints default to NONCLUSTERED.</code></p>
</blockquote>
<p>而 Clustered Index 在 PostgreSQL 裡有別於 SQL server，需透過 <code>CLUSTER</code> 的指令來完成 Clustered Index。</p>
<p>具體實現機制參考 Stack Overflow - <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4796548/about-clustered-index-in-postgres">About clustered index in postgres</a>相關討論。</p>
<h2 id="Non-clustered-Index"><a href="#Non-clustered-Index" class="headerlink" title="Non-clustered Index"></a>Non-clustered Index</h2><p>中文作 <strong>非叢集索引</strong>，概念類似書(比喻作資料表)的<strong>附錄</strong>，每本書可以有多個附錄，每張資料表能有多個 <strong>Non-clustered Index</strong>。</p>
<h1 id="比較有無-index-差異"><a href="#比較有無-index-差異" class="headerlink" title="比較有無 index 差異"></a>比較有無 index 差異</h1><p>先建立 1 百萬筆測試資料</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> employees( id serial <span class="hljs-keyword">primary</span> key, name text);<br>    <br><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> replace <span class="hljs-keyword">function</span> random_string(length <span class="hljs-type">integer</span>) <span class="hljs-keyword">returns</span> text <span class="hljs-keyword">as</span> <br>    $$<br>    <span class="hljs-keyword">declare</span><br>      chars text[] :<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#123;0,1,2,3,4,5,6,7,8,9,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z&#125;&#x27;</span>;<br>      <span class="hljs-keyword">result</span> text :<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#x27;</span>;<br>      i <span class="hljs-type">integer</span> :<span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>      length2 <span class="hljs-type">integer</span> :<span class="hljs-operator">=</span> (<span class="hljs-keyword">select</span> trunc(random() <span class="hljs-operator">*</span> length <span class="hljs-operator">+</span> <span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">begin</span><br>      if length2 <span class="hljs-operator">&lt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span><br>        raise exception <span class="hljs-string">&#x27;Given length cannot be less than 0&#x27;</span>;<br>      <span class="hljs-keyword">end</span> if;<br>      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span>.length2 loop<br>        <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> <span class="hljs-keyword">result</span> <span class="hljs-operator">||</span> chars[<span class="hljs-number">1</span><span class="hljs-operator">+</span>random()<span class="hljs-operator">*</span>(array_length(chars, <span class="hljs-number">1</span>)<span class="hljs-number">-1</span>)];<br>      <span class="hljs-keyword">end</span> loop;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">result</span>;<br>    <span class="hljs-keyword">end</span>;<br>    $$ <span class="hljs-keyword">language</span> plpgsql;<br>    <br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> employees(name)(<span class="hljs-keyword">select</span> random_string(<span class="hljs-number">10</span>) <span class="hljs-keyword">from</span> generate_series(<span class="hljs-number">0</span>, <span class="hljs-number">1000000</span>));<br></code></pre></td></tr></table></figure>

<p>查看資料表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">-</span># \d employees;<br>             <span class="hljs-keyword">Table</span> &quot;public.employees&quot;<br><span class="hljs-keyword">Column</span> <span class="hljs-operator">|</span>  Type   <span class="hljs-operator">|</span> <span class="hljs-keyword">Collation</span> <span class="hljs-operator">|</span> Nullable <span class="hljs-operator">|</span>                <span class="hljs-keyword">Default</span><br><span class="hljs-comment">--------+---------+-----------+----------+---------------------------------------</span><br>id     <span class="hljs-operator">|</span> <span class="hljs-type">integer</span> <span class="hljs-operator">|</span>           <span class="hljs-operator">|</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-operator">|</span> nextval(<span class="hljs-string">&#x27;employees_id_seq&#x27;</span>::regclass)<br>name   <span class="hljs-operator">|</span> text    <span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span><br>Indexes:<br>  &quot;employees_pkey&quot; <span class="hljs-keyword">PRIMARY</span> KEY, btree (id)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>注意:<br>PostgreSQL 裡，每個 primary key 預設都會另外建一個 btree 類型的 index</p>
</blockquote>
<p>查詢 employees 表裡的 <code>id = 2000</code> 的 id 值， 並透過查詢計劃 <code>explain analyze</code> 語句來分析查詢效能</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain analyze <span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>;<br></code></pre></td></tr></table></figure>

<p>查詢結果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">QUERY PLAN<br><span class="hljs-comment">-------------------------------------------------------------------------------------------------------------------------------</span><br> Index <span class="hljs-keyword">Only</span> Scan <span class="hljs-keyword">using</span> employees_pkey <span class="hljs-keyword">on</span> employees  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.42</span>.<span class="hljs-number">.4</span><span class="hljs-number">.44</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">4</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.058</span>.<span class="hljs-number">.0</span><span class="hljs-number">.062</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   Index Cond: (id <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>)<br>   Heap Fetches: <span class="hljs-number">0</span><br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">0.201</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">0.113</span> ms<br>(<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>
<p>結果裡可以看到有命中預設的 index，查詢速度變非常快。</p>
<p><code>Heap Fetches: 0</code> ：不需要存取 Heap Table File 的資料，直接存取 index 就可以拿到資料，因為查詢語句指定的欄位只有 <code>id</code> 而已，而 <code>id</code> 在 Postgres 裡有預設建立好的 index，故不需從 Heap Table File 找對應的值。</p>
<blockquote>
<p>Postgres 預設會在每張表的主鍵(<code>Primary Key</code>)或被設唯一限制(<code>UNIQUE Constraint</code>)的欄位自動建立 index 。</p>
</blockquote>
<p>Source: <a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/indexes-unique.html">PostgreSQL Docs</a></p>
<blockquote>
<p><em>PostgreSQL automatically creates a unique index when a unique constraint or primary key is defined for a table. The index covers the columns that make up the primary key or unique constraint (a multicolumn index, if appropriate), and is the mechanism that enforces the constraint.</em></p>
</blockquote>
<p>把 <code>select</code> 出來的欄位改成非預設建立 index 欄位 - <code>name</code> ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">937481</span>;<br>                                                        QUERY PLAN<br><span class="hljs-comment">--------------------------------------------------------------------------------------------------------------------------</span><br> Index Scan <span class="hljs-keyword">using</span> employees_pkey <span class="hljs-keyword">on</span> employees  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.42</span>.<span class="hljs-number">.8</span><span class="hljs-number">.44</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">6</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.219</span>.<span class="hljs-number">.0</span><span class="hljs-number">.225</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   Index Cond: (id <span class="hljs-operator">=</span> <span class="hljs-number">937481</span>)<br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">0.323</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">0.306</span> ms<br>(<span class="hljs-number">4</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>
<p><code>name</code> 欄位未被設為 index，會存放於 disk 裡的 heap table，故資料庫要先去 heap table 拿對應的資料，所以多一段花費時間。</p>
<blockquote>
<p>Tips:<br>執行重複的查詢會發現花費時間會縮短，原因是資料庫本身的快取(Cache) 機制</p>
</blockquote>
<p>若把 <code>WHERE</code> 條件改成 <code>name</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Zs&#x27;</span>;<br>                                                       QUERY PLAN<br><span class="hljs-comment">-------------------------------------------------------------------------------------------------------------------------</span><br> Gather  (cost<span class="hljs-operator">=</span><span class="hljs-number">1000.00</span>.<span class="hljs-number">.11310</span><span class="hljs-number">.94</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">6</span> width<span class="hljs-operator">=</span><span class="hljs-number">6</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">179.857</span>.<span class="hljs-number">.333</span><span class="hljs-number">.772</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">21</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   Workers Planned: <span class="hljs-number">2</span><br>   Workers Launched: <span class="hljs-number">2</span><br>   <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>  Parallel Seq Scan <span class="hljs-keyword">on</span> employees  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.00</span>.<span class="hljs-number">.10310</span><span class="hljs-number">.34</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">2</span> width<span class="hljs-operator">=</span><span class="hljs-number">6</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">14.909</span>.<span class="hljs-number">.147</span><span class="hljs-number">.673</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">7</span> loops<span class="hljs-operator">=</span><span class="hljs-number">3</span>)<br>         <span class="hljs-keyword">Filter</span>: (name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Zs&#x27;</span>::text)<br>         <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> <span class="hljs-keyword">Filter</span>: <span class="hljs-number">333327</span><br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">0.944</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">334.032</span> ms<br>(<span class="hljs-number">8</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>
<p>在沒有命中 index 的查詢下，Postgres Planner 會採 <code>Seq Scan</code> (Sequential Scan) 的方式搜尋整張資料表(full table scan)，花費時間為 <strong>334.032 ms</strong> ，較先前查詢費時許多，從結果可觀察到有沒有命中 index 在資料量大的狀況下會顯著地影響查詢效能。</p>
<h2 id="建立-Index-的缺點"><a href="#建立-Index-的缺點" class="headerlink" title="建立 Index 的缺點"></a>建立 Index 的缺點</h2><p>雖然 index 有助於提升搜尋效能，但也有其缺點，如：Index 會佔用資料庫的空間，是以空間來換取時間，且每次在表中新增、修改或刪除時，都必須更動該表上的所有 Index，Index 建越多，資料庫需要執行的工作就越多，花額外成本來維護 Index，最終導致效能降低，應謹慎評估使用 Index。</p>
<blockquote>
<p>Index 雖有助於提高 <strong>查詢(SELECT)</strong> 速度，但會降低 <strong>寫入(INSERT)</strong> 以及 <strong>更新(UPDATE)</strong> 資料的速度 → 因為同時要更動 Index</p>
</blockquote>
<h2 id="思考是否真的需要建-Index-的情況"><a href="#思考是否真的需要建-Index-的情況" class="headerlink" title="思考是否真的需要建 Index  的情況"></a>思考是否真的需要建 Index  的情況</h2><ul>
<li>資料量較小的表</li>
<li>該欄位頻繁且大量被更新或新增</li>
<li>避免使用包含太多 <code>NULL</code> 值的欄位</li>
</ul>
<h2 id="評估-Index-Hit-Rate"><a href="#評估-Index-Hit-Rate" class="headerlink" title="評估 Index Hit Rate"></a>評估 Index Hit Rate</h2><p>執行下方的 SQL 語句可以查看 Index 命中的比率，藉此評估建好的 Index 是不是在查詢時被有效命中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>    t.schemaname,<br>    t.relname <span class="hljs-keyword">as</span> &quot;Table Name&quot;,<br>    io_i.indexrelname <span class="hljs-keyword">as</span> &quot;Index Name&quot;,<br>    <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (io_i.idx_blks_hit <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> io_i.idx_blks_read <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>    round(io_i.idx_blks_hit<span class="hljs-operator">/</span>(io_i.idx_blks_hit::<span class="hljs-type">numeric</span> <span class="hljs-operator">+</span><br>    io_i.idx_blks_read::<span class="hljs-type">numeric</span>), <span class="hljs-number">4</span>) <span class="hljs-keyword">else</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> &quot;Index Hit Ratio&quot;<br><span class="hljs-keyword">from</span><br>    pg_stat_user_tables t<br>    <span class="hljs-keyword">join</span> pg_statio_user_indexes io_i <span class="hljs-keyword">on</span> io_i.relid <span class="hljs-operator">=</span> t.relid<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> &quot;Index Hit Ratio&quot; <span class="hljs-keyword">desc</span>;<br></code></pre></td></tr></table></figure>

<h2 id="建立-index"><a href="#建立-index" class="headerlink" title="建立 index"></a>建立 index</h2><p>語法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> index <span class="hljs-operator">&lt;</span>index_name<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">on</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">table</span><span class="hljs-operator">&gt;</span>(<span class="hljs-operator">&lt;</span><span class="hljs-keyword">column</span><span class="hljs-operator">&gt;</span>);<br></code></pre></td></tr></table></figure>
<h3 id="範例："><a href="#範例：" class="headerlink" title="範例："></a>範例：</h3><p>替 employees 表裡的 <code>name</code> 欄位建 index</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> index employees_name <span class="hljs-keyword">on</span> employees(name);<br></code></pre></td></tr></table></figure>

<p>再執行一次 name 的查詢</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">SELECT</span> id,name <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Zs&#x27;</span>;<br>                                                       QUERY PLAN<br><span class="hljs-comment">------------------------------------------------------------------------------------------------------------------------</span><br> Bitmap Heap Scan <span class="hljs-keyword">on</span> employees  (cost<span class="hljs-operator">=</span><span class="hljs-number">4.47</span>.<span class="hljs-number">.27</span><span class="hljs-number">.93</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">6</span> width<span class="hljs-operator">=</span><span class="hljs-number">10</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.930</span>.<span class="hljs-number">.1</span><span class="hljs-number">.211</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">21</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   Recheck Cond: (name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Zs&#x27;</span>::text)<br>   Heap Blocks: exact<span class="hljs-operator">=</span><span class="hljs-number">21</span><br>   <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>  Bitmap Index Scan <span class="hljs-keyword">on</span> employees_name  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.00</span>.<span class="hljs-number">.4</span><span class="hljs-number">.47</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">6</span> width<span class="hljs-operator">=</span><span class="hljs-number">0</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.859</span>.<span class="hljs-number">.0</span><span class="hljs-number">.861</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">21</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>         Index Cond: (name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Zs&#x27;</span>::text)<br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">3.024</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">1.299</span> ms<br>(<span class="hljs-number">7</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>
<p>命中 index 的情況下，執行時間下修到只剩 1.299 ms。</p>
<p>雖說有對 <code>name</code> 欄位下了 index，但特定情況下仍可能無法發揮作用。<br>例如： 將剛剛 <code>WHERE =</code>  的條件改為 <code>LIKE</code> </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">SELECT</span> id,name <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%ZA%&#x27;</span>;<br>	QUERY PLAN<br><span class="hljs-comment">----------------------------------------------------------------------------------------------------------------------------</span><br> Gather  (cost<span class="hljs-operator">=</span><span class="hljs-number">1000.00</span>.<span class="hljs-number">.11319</span><span class="hljs-number">.34</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">90</span> width<span class="hljs-operator">=</span><span class="hljs-number">10</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">1.113</span>.<span class="hljs-number">.132</span><span class="hljs-number">.030</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1215</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   Workers Planned: <span class="hljs-number">2</span><br>   Workers Launched: <span class="hljs-number">2</span><br>   <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>  Parallel Seq Scan <span class="hljs-keyword">on</span> employees  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.00</span>.<span class="hljs-number">.10310</span><span class="hljs-number">.34</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">38</span> width<span class="hljs-operator">=</span><span class="hljs-number">10</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.340</span>.<span class="hljs-number">.114</span><span class="hljs-number">.713</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">405</span> loops<span class="hljs-operator">=</span><span class="hljs-number">3</span>)<br>         <span class="hljs-keyword">Filter</span>: (name <span class="hljs-operator">~</span><span class="hljs-operator">~</span> <span class="hljs-string">&#x27;%ZA%&#x27;</span>::text)<br>         <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> <span class="hljs-keyword">Filter</span>: <span class="hljs-number">332929</span><br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">2.710</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">132.185</span> ms<br>(<span class="hljs-number">8</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>
<p>從結果觀察到同樣以 <code>name</code> 作為搜尋條件，卻出現沒有命中 index 的情形，選擇用 <code>Seq Scan</code> (Sequential Scan)的方式掃描整張表，由此可知並非只要加上 index，資料庫的 Planner 就會在每次搜尋時選擇 index。</p>
<h1 id="Index-Scan-v-s-Index-Only-Scan"><a href="#Index-Scan-v-s-Index-Only-Scan" class="headerlink" title="Index Scan v.s. Index Only Scan"></a>Index Scan v.s. Index Only Scan</h1><p>Index Only Scan 與 Index Scan 兩者主要差異在於:</p>
<blockquote>
<p><strong>Index Only Scan</strong> 的資料是直接來自於 index，不需要再到 Heap File 取得資料，一般來說讀取的速度較 Index Scan 更快。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> grades (<br>id serial <span class="hljs-keyword">primary</span> key, <br> g <span class="hljs-type">int</span>,<br> name text <br>); <br><br><span class="hljs-comment">-- 寫入測試資料</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> grades (g,<br>name  ) <br><span class="hljs-keyword">select</span> <br>random()<span class="hljs-operator">*</span><span class="hljs-number">100</span>,<br><span class="hljs-built_in">substring</span>(md5(random()::text ),<span class="hljs-number">0</span>,<span class="hljs-built_in">floor</span>(random()<span class="hljs-operator">*</span><span class="hljs-number">31</span>)::<span class="hljs-type">int</span>)<br> <span class="hljs-keyword">from</span> generate_series(<span class="hljs-number">0</span>, <span class="hljs-number">500</span>);<br><br><span class="hljs-comment">-- 建 index</span><br><span class="hljs-keyword">CREATE</span> INDEX id_idx <span class="hljs-keyword">ON</span> grades(id);<br></code></pre></td></tr></table></figure>

<p>分別測試 <code>SELECT</code> 不同欄位的結果：</p>
<p>查詢 id</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> grades <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">7</span>;<br>	QUERY PLAN<br><span class="hljs-comment">--------------------------------------------------------------------------------------------------------------------</span><br> Index <span class="hljs-keyword">Only</span> Scan <span class="hljs-keyword">using</span> id_idx <span class="hljs-keyword">on</span> grades  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.27</span>.<span class="hljs-number">.8</span><span class="hljs-number">.29</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">4</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.073</span>.<span class="hljs-number">.0</span><span class="hljs-number">.078</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   Index Cond: (id <span class="hljs-operator">=</span> <span class="hljs-number">7</span>)<br>   Heap Fetches: <span class="hljs-number">1</span><br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">0.249</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">0.130</span> ms<br>(<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>

<p>查詢 name</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">select</span> name <span class="hljs-keyword">from</span> grades <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">7</span>;<br>	QUERY PLAN<br><span class="hljs-comment">----------------------------------------------------------------------------------------------------------------</span><br> Index Scan <span class="hljs-keyword">using</span> id_idx <span class="hljs-keyword">on</span> grades  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.27</span>.<span class="hljs-number">.8</span><span class="hljs-number">.29</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">15</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.060</span>.<span class="hljs-number">.0</span><span class="hljs-number">.064</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   Index Cond: (id <span class="hljs-operator">=</span> <span class="hljs-number">7</span>)<br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">0.360</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">0.219</span> ms<br>(<span class="hljs-number">4</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>

<p>比較上方兩條 query，經由 <code>explain</code> 分析的結果，下方的 query 查詢的 name 欄位需到 Heap Table File 裡讀取 name 對應的資料。</p>
<p>相較之下查詢 id 的 query 因為 id 本身已被設定為 index，故資料庫在讀取 index 時，會一起將命中的 index 值一並取出並回傳。</p>
<h2 id="Includes-Index"><a href="#Includes-Index" class="headerlink" title="Includes Index"></a>Includes Index</h2><p>如果希望把其他欄位的值也存在 index 上，可以採用 <code>include</code> 的 SQL 語句結合 index 將其他欄位納入 index。</p>
<p>範例:<br>先移除原先建立好的 index</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> index id_idx;<br></code></pre></td></tr></table></figure>

<p>將 name 欄位納入 index</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> index id_idx <span class="hljs-keyword">on</span> grades(id) include (name)<br></code></pre></td></tr></table></figure>

<p>查看建好 index 後的結果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># \d grades;<br>                            <span class="hljs-keyword">Table</span> &quot;public.grades&quot;<br> <span class="hljs-keyword">Column</span> <span class="hljs-operator">|</span>  Type   <span class="hljs-operator">|</span> <span class="hljs-keyword">Collation</span> <span class="hljs-operator">|</span> Nullable <span class="hljs-operator">|</span>              <span class="hljs-keyword">Default</span><br><span class="hljs-comment">--------+---------+-----------+----------+------------------------------------</span><br> id     <span class="hljs-operator">|</span> <span class="hljs-type">integer</span> <span class="hljs-operator">|</span>           <span class="hljs-operator">|</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-operator">|</span> nextval(<span class="hljs-string">&#x27;grades_id_seq&#x27;</span>::regclass)<br> g      <span class="hljs-operator">|</span> <span class="hljs-type">integer</span> <span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span><br> name   <span class="hljs-operator">|</span> text    <span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span><br>Indexes:<br>    &quot;grades_pkey&quot; <span class="hljs-keyword">PRIMARY</span> KEY, btree (id)<br>    &quot;id_idx&quot; btree (id) INCLUDE (name)<br></code></pre></td></tr></table></figure>

<p>接著對 <code>SELECT</code> 語句進行分析</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">select</span> name <span class="hljs-keyword">from</span> grades <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">7</span>;<br>                                                     QUERY PLAN<br><span class="hljs-comment">---------------------------------------------------------------------------------------------------------------------</span><br> Index <span class="hljs-keyword">Only</span> Scan <span class="hljs-keyword">using</span> id_idx <span class="hljs-keyword">on</span> grades  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.27</span>.<span class="hljs-number">.8</span><span class="hljs-number">.29</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">15</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.097</span>.<span class="hljs-number">.0</span><span class="hljs-number">.103</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   Index Cond: (id <span class="hljs-operator">=</span> <span class="hljs-number">7</span>)<br>   Heap Fetches: <span class="hljs-number">1</span><br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">1.745</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">0.182</span> ms<br>(<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>

<p>加了 <code>include</code> 之後，<code>explain</code> 分析的結果從 <code>Index Scan</code> → <code>Index Only Scan</code>，代表查詢連同後來納入的 <code>name</code> 值直接從 Index 裡面取出，沒有額外到 Heap Table File 裡取值。</p>
<blockquote>
<p>NOTE：</p>
<ul>
<li><code>include</code> 會把其他指定的欄位納入 Index，適合把 <code>include</code> 指定的欄位用在 <code>Index Only Scan</code> 的策略上。</li>
<li>重要：<code>include</code> 的欄位並 <strong>不作為</strong> Index 的 search key！故把上面的查詢條件 <code>where</code> 改為 <code>name</code> 時，資料庫就不會在 Index 裡搜尋到 <code>name</code> 值。</li>
<li>會增加 Index 的大小，隨著 Index 的增長，查詢 index 的速度會變慢，故在使用上要評估實際使用的場景以及取捨，再決定是否要採用。</li>
</ul>
</blockquote>
<p>將剛剛 <code>include</code> 的 <code>name</code> 欄位作為 <code>where</code> 條件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">select</span> name <span class="hljs-keyword">from</span> grades <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Zs&#x27;</span>;<br>          QUERY PLAN<br><span class="hljs-comment">--------------------------------------------------------------------------------------------------</span><br> Seq Scan <span class="hljs-keyword">on</span> grades  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.00</span>.<span class="hljs-number">.10</span><span class="hljs-number">.26</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> width<span class="hljs-operator">=</span><span class="hljs-number">15</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.661</span>.<span class="hljs-number">.0</span><span class="hljs-number">.663</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">0</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   <span class="hljs-keyword">Filter</span>: (name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Zs&#x27;</span>::text)<br>   <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> <span class="hljs-keyword">Filter</span>: <span class="hljs-number">501</span><br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">0.365</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">0.733</span> ms<br>(<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>
<p>從上述分析結果得知，雖然 <code>name</code> 透過 <code>include</code> 被納入 <code>id_idx</code>，但 <code>id_idx</code> 的 search key 是 <code>id</code> 欄位非 <code>name</code>，資料庫採用 <code>Seq Scan</code> 的方式。</p>
<h2 id="分析-index-使用的情況"><a href="#分析-index-使用的情況" class="headerlink" title="分析 index 使用的情況"></a>分析 index 使用的情況</h2><p>透過以下的 SQL query 可以查詢到 index 的使用情形</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> pg_stat_user_indexes;<br></code></pre></td></tr></table></figure>

<p>查詢結果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">relid  | indexrelid | schemaname |  relname  | indexrelname   | idx_scan | idx_tup_read | idx_tup_fetch<br>-------+------------+------------+------------+-------------------------+----------+--------------+---------------<br>39249  |      39256 | public     | employees | employees_pkey |       36 |      2000035 |       2000032<br> 39249 |      39259 | public     | employees | employees_name |        2 |           21 |             0<br> 39262 |      39269 | public     | grades    | grades_pkey    |        0 |            0 |             0<br> 39262 |      39272 | public     | grades    | id_idx         |       17 |           17 |            17<br></code></pre></td></tr></table></figure>

<h2 id="查看指定的-index-大小"><a href="#查看指定的-index-大小" class="headerlink" title="查看指定的 index 大小"></a>查看指定的 index 大小</h2><p>語法：<br><code>&lt;index_name&gt;</code> 替換成指定的 index 名稱</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> pg_size_pretty(pg_relation_size(<span class="hljs-string">&#x27;&lt;index_name&gt;&#x27;</span>));<br></code></pre></td></tr></table></figure>

<p>範例： 查看 <code>grades</code> 這張表的 index: <code>id_idx</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># <span class="hljs-keyword">SELECT</span> pg_size_pretty(pg_relation_size(<span class="hljs-string">&#x27;id_idx&#x27;</span>));<br> pg_size_pretty<br><span class="hljs-comment">----------------</span><br> <span class="hljs-number">40</span> kB<br>(<span class="hljs-number">1</span> <span class="hljs-type">row</span>)<br></code></pre></td></tr></table></figure>
<h1 id="延伸探討"><a href="#延伸探討" class="headerlink" title="延伸探討"></a>延伸探討</h1><blockquote>
<p>為什麼 Postgres 有時不選擇 Index Scan 卻選擇 Sequential Scan？</p>
</blockquote>
<p>有時候 PostgreSQL 在查詢時會選擇用 Sequential Scan 的方式，不採用下好的 Index 做 Index Scan，主要有幾個原因:</p>
<h2 id="資料類型不匹配"><a href="#資料類型不匹配" class="headerlink" title="資料類型不匹配"></a>資料類型不匹配</h2><p>有些強制型別轉換會導致 Index 未被使用的情形，我們拿前面的 SQL 範例做調整，把搜尋條件 <code>id</code> 加上型別轉換(<code>cast</code>) <code>::numeric</code> 的語句，改成下方的樣子:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain analyze <span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> grades <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">7</span>::<span class="hljs-type">numeric</span>;<br></code></pre></td></tr></table></figure>

<p>型別轉換阻止 Postgres 使用建立好的 Index，藉由 <code>explain analyze</code> 分析產生以下結果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># explain analyze <span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> grades <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">7</span>::<span class="hljs-type">numeric</span>;<br>                                           QUERY PLAN<br><span class="hljs-comment">-------------------------------------------------------------------------------------------------</span><br> Seq Scan <span class="hljs-keyword">on</span> grades  (cost<span class="hljs-operator">=</span><span class="hljs-number">0.00</span>.<span class="hljs-number">.11</span><span class="hljs-number">.52</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">3</span> width<span class="hljs-operator">=</span><span class="hljs-number">4</span>) (actual <span class="hljs-type">time</span><span class="hljs-operator">=</span><span class="hljs-number">0.086</span>.<span class="hljs-number">.0</span><span class="hljs-number">.840</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> loops<span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br>   <span class="hljs-keyword">Filter</span>: ((id)::<span class="hljs-type">numeric</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;7&#x27;</span>::<span class="hljs-type">numeric</span>)<br>   <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> <span class="hljs-keyword">Filter</span>: <span class="hljs-number">500</span><br> Planning <span class="hljs-type">Time</span>: <span class="hljs-number">0.372</span> ms<br> Execution <span class="hljs-type">Time</span>: <span class="hljs-number">0.899</span> ms<br>(<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure>
<p>從結果可看出 Postgres Planner 選擇 <code>Seq Scan</code> 而非前面的 <code>Index Only Scan using id_idx on grades</code></p>
<h2 id="評估結果是Sequential-Scan-更快"><a href="#評估結果是Sequential-Scan-更快" class="headerlink" title="評估結果是Sequential Scan 更快"></a>評估結果是Sequential Scan 更快</h2><p>在資料量很小時，Sequential Scan 會比 Index Scan 更加有效，原因是 Index Scan 至少要發生兩次 I/O，一次是讀取 Index 的資料，一次是讀取 Heap File 裡的資料，搜尋代價遠高於 Index Scan。</p>
<h1 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h1><p>前面談到有設置且命中 Index 在資料量大的情況下，對查詢效率會有顯著的差異。</p>
<p>使用 Index 前也須考量使用情境與其缺點，而且並非只要建立好 Index，SQL 查詢就一定會命中 Index，這些都是使用上要注意的地方。</p>
<p>善用 PostgresSQL Planner 的提示有助於評估當前 SQL 運行的狀況，衡量如何使用 Index。</p>
<h1 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-clustered-and-non-clustered-index/">Difference between Clustered and Non-clustered index</a></li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/indexes-index-only-scans.html">Index-Only Scans and Covering Indexes</a></li>
<li><a target="_blank" rel="noopener" href="https://postgrespro.com/blog/pgsql/3994098">Indexes in PostgreSQL — 1</a></li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/sql-cluster.html">CLUSTER - PostgreSQL Docs</a></li>
</ul>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="../../../../../tags/Database/">Database</a><a class="link-muted mr-2" rel="tag" href="../../../../../tags/Postgres/">Postgres</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="../../../20/Database/%E8%B3%87%E6%96%99%E5%BA%AB%E5%A6%82%E4%BD%95%E5%AD%98%E6%94%BE%E8%B3%87%E6%96%99/"><span class="level-item">[Postgres] 資料庫裡的儲存概念</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "5004535474ff3956a63b182072bd7d7e",
            repo: "ChenTsungYu.github.io",
            owner: "ChenTsungYu",
            clientID: "7913190f1a943b88e276",
            clientSecret: "8c54a86c8fe06b650efe932eb53bc421ddf84773",
            admin: ["ChenTsungYu"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="../../../../../img/avatar1.jpg" alt="Tsung Yu Chen"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Tsung Yu Chen</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Taiwan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="../../../../../archives"><p class="title">109</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="../../../../../categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="../../../../../tags"><p class="title">47</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="../../../../../https:/github.com/ChenTsungYu"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="../../../../../https:/www.facebook.com/zong.y.r/"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="../../../../../https:/www.linkedin.com/in/tom-chen-1012/"><i class="fab fa-linkedin-in"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="../../../../../categories/Backend/"><span class="level-start"><span class="level-item">Backend</span></span><span class="level-end"><span class="level-item tag">47</span></span></a></li><li><a class="level is-mobile" href="../../../../../categories/Cloud/"><span class="level-start"><span class="level-item">Cloud</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="../../../../../categories/Conference/"><span class="level-start"><span class="level-item">Conference</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="../../../../../categories/DevOps/"><span class="level-start"><span class="level-item">DevOps</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="../../../../../categories/Frontend/"><span class="level-start"><span class="level-item">Frontend</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="../../../../../categories/Network/"><span class="level-start"><span class="level-item">Network</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="../../../../../categories/OS/"><span class="level-start"><span class="level-item">OS</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="../../../../../categories/Tool/"><span class="level-start"><span class="level-item">Tool</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="../../../../../archives/2022/06/"><span class="level-start"><span class="level-item">June 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2021/10/"><span class="level-start"><span class="level-item">October 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2021/09/"><span class="level-start"><span class="level-item">September 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2021/06/"><span class="level-start"><span class="level-item">June 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2021/04/"><span class="level-start"><span class="level-item">April 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2021/03/"><span class="level-start"><span class="level-item">March 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2020/10/"><span class="level-start"><span class="level-item">October 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2020/09/"><span class="level-start"><span class="level-item">September 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2020/07/"><span class="level-start"><span class="level-item">July 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2020/06/"><span class="level-start"><span class="level-item">June 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2020/04/"><span class="level-start"><span class="level-item">April 2020</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2020/02/"><span class="level-start"><span class="level-item">February 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2020/01/"><span class="level-start"><span class="level-item">January 2020</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2019/09/"><span class="level-start"><span class="level-item">September 2019</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2019/08/"><span class="level-start"><span class="level-item">August 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="../../../../../archives/2019/07/"><span class="level-start"><span class="level-item">July 2019</span></span><span class="level-end"><span class="level-item tag">25</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="../../../../../tags/AWS/"><span class="tag">AWS</span><span class="tag">14</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Ansible/"><span class="tag">Ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Canvas/"><span class="tag">Canvas</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Certbot/"><span class="tag">Certbot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Conference/"><span class="tag">Conference</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Cookie/"><span class="tag">Cookie</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Css/"><span class="tag">Css</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Database/"><span class="tag">Database</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/DevOps/"><span class="tag">DevOps</span><span class="tag">16</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Django/"><span class="tag">Django</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Docker/"><span class="tag">Docker</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/ELK/"><span class="tag">ELK</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Elasticsearch/"><span class="tag">Elasticsearch</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Github/"><span class="tag">Github</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Go/"><span class="tag">Go</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/GoogleMap/"><span class="tag">GoogleMap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/JSDC/"><span class="tag">JSDC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/K8s/"><span class="tag">K8s</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Kibana/"><span class="tag">Kibana</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Linux/"><span class="tag">Linux</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Mac/"><span class="tag">Mac</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/MySQL/"><span class="tag">MySQL</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Network/"><span class="tag">Network</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/NoSQL/"><span class="tag">NoSQL</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/OOP/"><span class="tag">OOP</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/OS/"><span class="tag">OS</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Pandas/"><span class="tag">Pandas</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Postgres/"><span class="tag">Postgres</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Project/"><span class="tag">Project</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Proxy/"><span class="tag">Proxy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Python/"><span class="tag">Python</span><span class="tag">26</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Redis/"><span class="tag">Redis</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/SQL-Server/"><span class="tag">SQL Server</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/SSL/"><span class="tag">SSL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Session/"><span class="tag">Session</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Terraform/"><span class="tag">Terraform</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Ubuntu/"><span class="tag">Ubuntu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/VSCode/"><span class="tag">VSCode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Vue/"><span class="tag">Vue</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/WebScraping/"><span class="tag">WebScraping</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/WebSocket/"><span class="tag">WebSocket</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/Webhook/"><span class="tag">Webhook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/w3HexSchool/"><span class="tag">w3HexSchool</span><span class="tag">21</span></a></div><div class="control"><a class="tags has-addons" href="../../../../../tags/%E8%A8%88%E6%A6%82/"><span class="tag">計概</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#Full-Table-Scan"><span class="level-left"><span class="level-item">2</span><span class="level-item">Full Table Scan</span></span></a></li><li><a class="level is-mobile" href="#什麼是-Index"><span class="level-left"><span class="level-item">3</span><span class="level-item">什麼是 Index?</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#什麼是-B-Tree"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">什麼是 B-Tree?</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#B-Tree-幾項重要特性"><span class="level-left"><span class="level-item">3.1.1</span><span class="level-item">B-Tree 幾項重要特性</span></span></a></li><li><a class="level is-mobile" href="#B-tree-是如何幫助資料庫搜尋"><span class="level-left"><span class="level-item">3.1.2</span><span class="level-item">B-tree 是如何幫助資料庫搜尋?</span></span></a></li><li><a class="level is-mobile" href="#Index-存放於-Disk-amp-Memory-的示意圖"><span class="level-left"><span class="level-item">3.1.3</span><span class="level-item">Index 存放於 Disk &amp; Memory 的示意圖</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#Clustered-Index-v-s-Non-clustered-Index"><span class="level-left"><span class="level-item">4</span><span class="level-item">Clustered Index v.s. Non-clustered Index</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Clustered-Index"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">Clustered Index</span></span></a></li><li><a class="level is-mobile" href="#Non-clustered-Index"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">Non-clustered Index</span></span></a></li></ul></li><li><a class="level is-mobile" href="#比較有無-index-差異"><span class="level-left"><span class="level-item">5</span><span class="level-item">比較有無 index 差異</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#建立-Index-的缺點"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">建立 Index 的缺點</span></span></a></li><li><a class="level is-mobile" href="#思考是否真的需要建-Index-的情況"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">思考是否真的需要建 Index  的情況</span></span></a></li><li><a class="level is-mobile" href="#評估-Index-Hit-Rate"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">評估 Index Hit Rate</span></span></a></li><li><a class="level is-mobile" href="#建立-index"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">建立 index</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#範例："><span class="level-left"><span class="level-item">5.4.1</span><span class="level-item">範例：</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#Index-Scan-v-s-Index-Only-Scan"><span class="level-left"><span class="level-item">6</span><span class="level-item">Index Scan v.s. Index Only Scan</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Includes-Index"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">Includes Index</span></span></a></li><li><a class="level is-mobile" href="#分析-index-使用的情況"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">分析 index 使用的情況</span></span></a></li><li><a class="level is-mobile" href="#查看指定的-index-大小"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">查看指定的 index 大小</span></span></a></li></ul></li><li><a class="level is-mobile" href="#延伸探討"><span class="level-left"><span class="level-item">7</span><span class="level-item">延伸探討</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#資料類型不匹配"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">資料類型不匹配</span></span></a></li><li><a class="level is-mobile" href="#評估結果是Sequential-Scan-更快"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">評估結果是Sequential Scan 更快</span></span></a></li></ul></li><li><a class="level is-mobile" href="#總結"><span class="level-left"><span class="level-item">8</span><span class="level-item">總結</span></span></a></li><li><a class="level is-mobile" href="#參考"><span class="level-left"><span class="level-item">9</span><span class="level-item">參考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="../../../../../js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-06-29T05:23:10.000Z">2022/06/29</time></p><p class="title"><a href="">[Postgres] 資料庫的索引(Index)</a></p><p class="categories"><a href="../../../../../categories/Backend/">Backend</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-06-20T05:23:10.000Z">2022/06/20</time></p><p class="title"><a href="../../../20/Database/%E8%B3%87%E6%96%99%E5%BA%AB%E5%A6%82%E4%BD%95%E5%AD%98%E6%94%BE%E8%B3%87%E6%96%99/">[Postgres] 資料庫裡的儲存概念</a></p><p class="categories"><a href="../../../../../categories/Backend/">Backend</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-15T05:23:10.000Z">2022/01/15</time></p><p class="title"><a href="../../../../01/15/Database/Redis/%5BBackend%5D%20%E6%8F%90%E9%AB%98%20Redis%20%E5%9F%B7%E8%A1%8C%E6%95%88%E7%8E%87%E7%9A%84%E6%96%B9%E6%B3%95%20-%20Pipeline/">[Redis] 提高 Redis 執行效率的方法 - Pipeline</a></p><p class="categories"><a href="../../../../../categories/Backend/">Backend</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-11T05:23:10.000Z">2022/01/11</time></p><p class="title"><a href="../../../../01/11/Database/Redis/%5BBackend%5D%20Redis%20-%20Transction/">[Redis] Redis - Transaction</a></p><p class="categories"><a href="../../../../../categories/Backend/">Backend</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-09T00:23:10.000Z">2022/01/09</time></p><p class="title"><a href="../../../../01/09/Database/Redis/%5BRedis%5D%20Redis%20%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B%20-%20Sorted%20Sets/">[Redis] Redis 資料結構 - Sorted Sets</a></p><p class="categories"><a href="../../../../../categories/Backend/">Backend</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="../../../../../index.html"><img src="../../../../../img/dragon_blue.png" alt="Tom&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Tsung Yu Chen</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="../../../../../https:/creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="../../../../../https:/creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="../../../../../https:/github.com/ChenTsungYu"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="../../../../../js/column.js"></script><script src="../../../../../js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="../../../../../js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="../../../../../js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="../../../../../js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"../../../../../content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>